<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Borsa Ekip Terminali v5.2 - MesajlaÅŸma & PortfÃ¶y</title>
    <script src="https://meet.jit.si/external_api.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --buy: #22c55e; --sell: #ef4444; --text: #f8fafc; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* GÄ°RÄ°Åž EKRANI */
        #setup-layer { position: fixed; inset: 0; background: var(--bg); z-index: 999; display: flex; align-items: center; justify-content: center; }
        .setup-card { background: var(--card); padding: 30px; border-radius: 15px; border: 1px solid var(--accent); width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        
        /* PANEL YAPISI */
        .sidebar { width: 35%; border-right: 1px solid #334155; display: flex; flex-direction: column; padding: 15px; overflow-y: auto; background: #111827; }
        .main-content { width: 65%; display: flex; flex-direction: column; background: #000; position: relative; }
        
        /* BÄ°LEÅžENLER */
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 5px solid var(--accent); }
        .active-buy { border-left-color: var(--buy); background: #064e3b !important; }
        input, select { width: 100%; padding: 10px; margin: 5px 0; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; }
        button { cursor: pointer; padding: 10px; border: none; border-radius: 6px; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--buy); color: white; }
        .btn-danger { background: var(--sell); color: white; }

        /* PORTFÃ–Y VE MESAJLAÅžMA */
        .portfolio-box { background: rgba(15, 23, 42, 0.7); padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.85rem; border: 1px solid #334155; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .kz-pos { color: var(--buy); font-weight: bold; }
        .kz-neg { color: var(--sell); font-weight: bold; }

        #chat-box { flex-grow: 1; min-height: 200px; max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; font-size: 0.85rem; margin-bottom: 10px; border: 1px solid #334155; }
        .msg { margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #1e293b; }
        
        #video-container { flex-grow: 1; width: 100%; height: 100%; }
    </style>
</head>
<body>

<div id="setup-layer">
    <div class="setup-card">
        <h2 style="color: var(--accent);">ðŸ“Š Ekip Terminali</h2>
        <input type="text" id="setup-name" placeholder="AdÄ±nÄ±z SoyadÄ±nÄ±z">
        <select id="setup-role">
            <option value="kullanici">KullanÄ±cÄ±</option>
            <option value="yonetici">YÃ¶netici</option>
        </select>
        <input type="password" id="setup-pass" placeholder="Grup Åžifresi">
        <button class="btn-primary" style="width:100%; margin-top:15px;" onclick="sistemiKur()">Sisteme Gir</button>
    </div>
</div>

<div class="sidebar">
    <div style="border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-bottom: 15px;">
        <h3 id="display-name" style="margin:0;">...</h3>
        <small id="display-role" style="color: var(--accent); font-weight:bold;"></small>
    </div>

    <div id="admin-area" style="display:none;" class="card">
        <strong>YÃ¶netici Paneli</strong>
        <input type="text" id="h-kod" placeholder="Hisse Kodu (THYAO)">
        <input type="number" id="h-hedef" placeholder="AlÄ±m Hedefi">
        <button class="btn-success" style="width:100%" onclick="hisseYayinla()">SÄ°NYALÄ° YAYINLA</button>
        <button class="btn-primary" style="width:100%; margin-top:8px;" onclick="window.location.href='/excel-indir'">ðŸ“Š EXCEL RAPORU</button>
    </div>

    <div id="stock-list"></div>

    <div class="card" style="border-left-color: #f59e0b;">
        <strong>ðŸ’¬ Ekip Sohbeti</strong>
        <div id="chat-box"></div>
        <div style="display: flex; gap: 5px;">
            <input type="text" id="chat-input" placeholder="Mesaj..." style="margin:0;">
            <button class="btn-primary" onclick="mesajGonder()">ðŸš€</button>
        </div>
    </div>

    <div id="admin-summary" style="display:none; margin-top:10px;">
        <h4>ðŸ‘¥ Ekip PortfÃ¶y Takibi</h4>
        <div id="summary-content"></div>
    </div>
</div>

<div class="main-content">
    <div id="meet-overlay" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center; z-index:10;">
        <button class="btn-primary" style="padding:15px 40px; font-size:1.1rem;" onclick="startMeeting()">ðŸ“ž GÃ–RÃœÅžMEYÄ° BAÅžLAT</button>
    </div>
    <div id="video-container"></div>
</div>

<script>
    let myName = localStorage.getItem("name");
    let myRole = localStorage.getItem("role");

    async function sistemiKur() {
        const name = document.getElementById('setup-name').value.trim();
        const role = document.getElementById('setup-role').value;
        const pass = document.getElementById('setup-pass').value.trim();

        if(!name || !pass) return alert("Eksik bilgi!");

        try {
            const resp = await fetch('/giris-yap', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({rol: role, sifre: pass})
            });

            if(resp.ok) {
                localStorage.setItem("name", name);
                localStorage.setItem("role", role);
                location.reload();
            } else alert("HatalÄ± ÅŸifre!");
        } catch (e) { alert("Sunucu hatasÄ±!"); }
    }

    if(myName && myRole) {
        document.getElementById('setup-layer').style.display = 'none';
        baslat();
    }

    function baslat() {
        document.getElementById('display-name').innerText = myName;
        document.getElementById('display-role').innerText = myRole.toUpperCase();
        if(myRole === 'yonetici') {
            document.getElementById('admin-area').style.display = 'block';
            document.getElementById('admin-summary').style.display = 'block';
        }
        verileriYenile();
        setInterval(verileriYenile, 30000); 
    }

    async function verileriYenile() {
        try {
            const resp = await fetch('/borsa-verileri');
            const data = await resp.json();
            
            // 1. Hisse Listesi GÃ¼ncelleme
            const sList = document.getElementById('stock-list');
            sList.innerHTML = "<h4>ðŸ“ˆ Sinyaller</h4>";
            data.hisseler.forEach(h => {
                const isAL = h.durum === "AL";
                const userStats = data.ekip[myName] ? data.ekip[myName][h.sembol] : null;
                let portHTML = "";

                if(userStats && userStats.adet > 0) {
                    const total = h.fiyat * userStats.adet;
                    const kz = (h.fiyat - userStats.maliyet) * userStats.adet;
                    portHTML = `
                        <div class="portfolio-box">
                            <div class="info-row"><span>Adet:</span> <span>${userStats.adet}</span></div>
                            <div class="info-row"><span>Maliyet:</span> <span>${userStats.maliyet} TL</span></div>
                            <div class="info-row" style="border-top:1px solid #444; margin-top:5px;">
                                <strong>DeÄŸer:</strong> <span>${total.toFixed(2)} TL</span>
                            </div>
                            <div class="info-row">
                                <strong>K/Z:</strong> <span class="${kz >= 0 ? 'kz-pos' : 'kz-neg'}">${kz.toFixed(2)} TL</span>
                            </div>
                        </div>`;
                }

                sList.innerHTML += `
                    <div class="card ${isAL ? 'active-buy' : ''}">
                        <div style="display:flex; justify-content:space-between;">
                            <strong>${h.sembol}</strong>
                            ${myRole === 'yonetici' ? `<button onclick="hisseSil('${h.sembol}')" style="background:none; color:var(--sell); border:none; cursor:pointer;">X</button>` : ''}
                        </div>
                        <div style="font-size:1.3rem; font-weight:bold;">${h.fiyat > 0 ? h.fiyat.toFixed(2) : '...'} TL</div>
                        <small>Hedef: ${h.hedef} TL</small>
                        ${portHTML}
                        ${myRole === 'kullanici' ? `
                            <div style="display:flex; gap:5px; margin-top:8px;">
                                <input type="number" id="q-${h.sembol}" placeholder="Adet" style="padding:5px;" value="${userStats ? userStats.adet : ''}">
                                <input type="number" id="c-${h.sembol}" placeholder="Mly" style="padding:5px;" value="${userStats ? userStats.maliyet : ''}">
                                <button class="btn-success" style="padding:5px 10px;" onclick="portGuncelle('${h.sembol}')">ðŸ’¾</button>
                            </div>` : ''}
                    </div>`;
            });

            // 2. Chat GÃ¼ncelleme
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = data.mesajlar.map(m => `
                <div class="msg">
                    <strong style="color:var(--accent)">${m.user}:</strong> <span>${m.text}</span>
                    <div style="font-size:0.7rem; opacity:0.5; text-align:right;">${m.time}</div>
                </div>`).join('');

            // 3. YÃ¶netici Ã–zeti
            if(myRole === 'yonetici') {
                const summary = document.getElementById('summary-content');
                summary.innerHTML = "";
                for (const [user, assets] of Object.entries(data.ekip)) {
                    let rows = Object.entries(assets).map(([h, i]) => `<div>${h}: ${i.adet} ad.</div>`).join('');
                    summary.innerHTML += `<div class="card" style="font-size:0.8rem; border-left-color:var(--buy)">
                        <strong>${user}</strong><br>${rows || 'Hisse yok'}</div>`;
                }
            }
        } catch (e) { console.log("Yenileme hatasÄ±."); }
    }

    async function mesajGonder() {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if(!text) return;
        await fetch('/mesaj-gonder', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user: myName, text: text })
        });
        input.value = "";
        verileriYenile();
    }

    async function portGuncelle(h) {
        const adet = document.getElementById(`q-${h}`).value;
        const maliyet = document.getElementById(`c-${h}`).value;
        await fetch('/adet-guncelle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ kullanici: myName, hisse: h, adet, maliyet })
        });
        verileriYenile();
    }

    async function hisseYayinla() {
        const h = document.getElementById('h-kod').value.toUpperCase();
        const hedef = document.getElementById('h-hedef').value;
        await fetch('/hisse-ekle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ hisse: h, hedef: hedef })
        });
        verileriYenile();
    }

    async function hisseSil(h) {
        if(!confirm("Silinsin mi?")) return;
        await fetch('/hisse-sil', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ hisse: h })
        });
        verileriYenile();
    }

    function startMeeting() {
        document.getElementById('meet-overlay').style.display = 'none';
        new JitsiMeetExternalAPI("meet.jit.si", { roomName: "BorsaGrup_Sohbet_v5", parentNode: document.querySelector('#video-container') });
    }
</script>
</body>
</html>