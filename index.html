<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Borsa Ekip Terminali v10.0</title>
    <script src="https://meet.jit.si/external_api.js"></script>
    <style>
        :root { --bg: #0b0f19; --card: #161e2d; --accent: #38bdf8; --buy: #10b981; --sell: #f43f5e; --text: #f1f5f9; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .col { display: flex; flex-direction: column; height: 100%; box-sizing: border-box; padding: 12px; }
        
        .col-left { width: 20%; border-right: 1px solid #2d3748; background: #0f172a; overflow-y: auto; }
        .col-main { width: 60%; background: #000; position: relative; padding: 0; }
        .col-right { width: 20%; border-left: 1px solid #2d3748; background: #0f172a; overflow-y: auto; }
        
        #setup-layer { position: fixed; inset: 0; background: var(--bg); z-index: 3000; display: flex; align-items: center; justify-content: center; }
        .setup-card { background: var(--card); padding: 30px; border-radius: 12px; border: 1px solid var(--accent); width: 320px; text-align: center; }
        
        .card { background: var(--card); padding: 10px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--accent); transition: 0.2s; cursor: pointer; }
        .card:hover { background: #1e293b; border-left-width: 8px; }
        .active-buy { border-left-color: var(--buy); background: #064e3b !important; }
        
        input, select { width: 100%; padding: 8px; margin: 4px 0; border-radius: 6px; border: 1px solid #2d3748; background: #0b0f19; color: white; font-size: 0.8rem; box-sizing: border-box; }
        button { cursor: pointer; padding: 10px; border: none; border-radius: 6px; font-weight: bold; width: 100%; margin-top: 5px; transition: 0.3s; }
        .btn-primary { background: var(--accent); color: #000; }
        .btn-success { background: var(--buy); color: white; }
        .btn-danger { background: var(--sell); color: white; }

        .overlay-nav { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; gap: 8px; z-index: 1000; }
        .nav-btn { background: rgba(22, 30, 45, 0.95); color: white; padding: 8px 15px; border-radius: 20px; border: 1px solid var(--accent); width: auto; font-size: 0.75rem; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .nav-btn:hover { background: var(--accent); color: #000; }

        #chat-box { flex-grow: 1; min-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 8px; font-size: 0.75rem; border: 1px solid #334155; margin-bottom: 10px; }
        .price-tag { font-size: 1.1rem; font-weight: 800; color: #fff; }

        .modal { display: none; position: fixed; z-index: 2500; inset: 0; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        .modal-content { background: var(--card); padding: 20px; border-radius: 12px; width: 350px; border: 1px solid var(--accent); }
        
        .realize-kar { border-left-color: gold; background: rgba(255, 215, 0, 0.1); }
    </style>
</head>
<body>

<div id="setup-layer">
    <div class="setup-card">
        <h3>游늵 Ekip Terminali v10</h3>
        <input type="text" id="setup-name" placeholder="Kullan캼c캼 Ad캼">
        <input type="password" id="setup-pass" placeholder="룔fre">
        <select id="setup-role"><option value="kullanici">Kullan캼c캼 Giri를</option><option value="yonetici">Y칬netici Giri를</option></select>
        <button class="btn-primary" onclick="sistemiKur()">S캻STEM캻 BA뢻AT</button>
    </div>
</div>

<div id="user-modal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">游논 Kullan캼c캼 Listesi</h3>
        <div id="user-modal-list" style="max-height:300px; overflow-y:auto;"></div>
        <button class="btn-primary" style="margin-top:15px;" onclick="closeModal()">KAPAT</button>
    </div>
</div>

<div class="col col-left">
    <button style="background:transparent; color:#666; font-size:9px; border:1px solid #333;" onclick="cikisyap()">游뛁 G칖VENL캻 칂IKI</button>
    <h4 style="margin-top:15px;">游늳 Sinyaller</h4>
    <div id="stock-list"></div>
    
    <div id="admin-panel" style="display:none; border-top: 1px solid var(--accent); padding-top:10px; margin-top:15px;">
        <strong>游닉 Y칬netim Paneli</strong>
        <input type="text" id="h-kod" placeholder="Hisse (칐rn: EREGL)">
        <input type="number" id="h-hedef" placeholder="Hedef Fiyat">
        <button class="btn-success" onclick="hisseEkle()">S캻NYAL캻 YAYINLA</button>
        <button class="btn-primary" onclick="openModal()">KULLANICI Y칐NET캻M캻</button>
        <button style="background:orange; color:black;" onclick="window.location.href='/excel-indir'">游늵 EXCEL RAPORU</button>
    </div>
</div>

<div class="col col-main">
    <div class="overlay-nav">
        <button class="nav-btn" onclick="openBroker()">游 A1 Capital 캻륿em (Trade)</button>
        <button class="nav-btn" onclick="openMeeting()">游꿘 Toplant캼y캼 Ba륿at</button>
    </div>
    <div id="tradingview_container" style="width:100%; height:100%;">
        <div id="tradingview_widget_container" style="width:100%; height:100%;"></div>
    </div>
</div>

<div class="col col-right">
    <div class="card" style="border-left-color: var(--accent);">
        <h4 style="margin:0 0 10px 0;">游늵 캻륿em Giri를</h4>
        <select id="p-tip" style="background: #1e293b; color: #38bdf8; font-weight: bold;">
            <option value="ALIS">游릭 H캻SSE ALDIM</option>
            <option value="SATIS">游댮 H캻SSE SATTIM</option>
        </select>
        <input type="text" id="p-hisse" placeholder="Hisse Se칞in" readonly style="background:#0b0f19; opacity:0.8;">
        <input type="number" id="p-adet" placeholder="캻륿em Adedi">
        <input type="number" id="p-fiyat" placeholder="캻륿em Fiyat캼">
        <button id="islem-btn" class="btn-success" onclick="islemKaydet()">캻뢻EM캻 ONAYLA</button>
    </div>

    <div id="realize-area" class="card realize-kar" style="display:none;">
        <small>Toplam Ger칞ekle른n K칙r/Zarar:</small>
        <div id="total-realized" style="font-size:1.2rem; font-weight:bold; color:gold;">0.00 TL</div>
    </div>

    <h4>游눫 Sohbet <button onclick="tabloTemizle('chat')" style="width:auto; font-size:9px; background:none; color:var(--sell); border:1px solid #333; float:right;">Sil</button></h4>
    <div id="chat-box"></div>
    <div style="display:flex; gap:5px; margin-bottom:15px;">
        <input type="text" id="chat-inp" placeholder="Mesaj..." style="margin:0;">
        <button class="btn-primary" style="width:auto; margin:0; padding:0 15px;" onclick="mesajGonder()">游</button>
    </div>

    <div id="admin-view" style="display:none;">
        <h4>游 Sistem Loglar캼 <button onclick="tabloTemizle('logs')" style="width:auto; font-size:9px; background:none; color:var(--sell); border:1px solid #333; float:right;">S캼f캼rla</button></h4>
        <div id="log-box" style="font-size: 0.7rem; background:rgba(0,0,0,0.2); height: 100px; overflow-y: auto; padding:5px; border-radius:5px;"></div>
    </div>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
    let myName = localStorage.getItem("name");
    let myRole = localStorage.getItem("role");
    let userListData = [];

    // --- S캻STEM G캻R캻 ---
    async function sistemiKur() {
        const user = document.getElementById('setup-name').value;
        const pass = document.getElementById('setup-pass').value;
        const role = document.getElementById('setup-role').value;
        const r = await fetch('/giris-yap', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user, sifre:pass, rol:role})});
        if(r.ok) { localStorage.setItem("name", user); localStorage.setItem("role", role); location.reload(); } else alert("Giri bilgileri hatal캼!");
    }

    function cikisyap() { localStorage.clear(); location.reload(); }

    if(myName && myRole) { document.getElementById('setup-layer').style.display='none'; baslat(); }

    function baslat() {
        if(myRole === 'yonetici') {
            document.getElementById('admin-panel').style.display = 'block';
            document.getElementById('admin-view').style.display = 'block';
            loglariGetir(); setInterval(loglariGetir, 30000);
        }
        updateChart("BIST:THYAO");
        verileriYenile(); setInterval(verileriYenile, 30000);
        chatYenile(); setInterval(chatYenile, 3000);
    }

    // --- D캻NAM캻K GRAF캻K ---
    function updateChart(symbol) {
        const container = document.getElementById('tradingview_container');
        container.innerHTML = '<div id="tradingview_widget_container" style="width:100%; height:100%;"></div>';
        
        let formattedSymbol = symbol.includes(":") ? symbol : "BIST:" + symbol;

        new TradingView.widget({
            "autosize": true,
            "symbol": formattedSymbol,
            "interval": "D",
            "timezone": "Europe/Istanbul",
            "theme": "dark",
            "style": "1",
            "locale": "tr",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "allow_symbol_change": true,
            "container_id": "tradingview_widget_container"
        });
    }

    // --- BA뢻ANTILAR ---
    function openBroker() { window.open('https://trade.a1capital.com.tr/', 'Broker', 'width=1200,height=800'); }
    function openMeeting() { window.open('https://meet.jit.si/BorsaTerminal_Ozel_Ekip', '_blank'); }

    // --- VER캻 YEN캻LEME ---
    async function verileriYenile() {
        try {
            const r = await fetch('/borsa-verileri');
            const d = await r.json();
            userListData = d.kullanicilar;
            const list = document.getElementById('stock-list');
            list.innerHTML = "";
            d.hisseler.forEach(h => {
                list.innerHTML += `
                    <div class="card ${h.durum === 'AL' ? 'active-buy' : ''}" 
                         onclick="updateChart('${h.sembol}'); document.getElementById('p-hisse').value='${h.sembol}';">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <strong>${h.sembol}</strong>
                            <span class="price-tag">${h.fiyat > 0 ? h.fiyat.toFixed(2) : '...'}</span>
                        </div>
                        <div style="font-size:0.7rem; opacity:0.6;">Hedef: ${h.hedef} TL</div>
                        ${myRole === 'yonetici' ? `<button class="btn-danger" style="font-size:8px; padding:2px; margin-top:5px;" onclick="hisseSil('${h.sembol}')">S캻NYAL캻 S캻L</button>` : ''}
                    </div>`;
            });

            if(d.realize_kar[myName]) {
                document.getElementById('realize-area').style.display = 'block';
                document.getElementById('total-realized').innerText = d.realize_kar[myName].toFixed(2) + " TL";
            }
        } catch(e) {}
    }

    async function chatYenile() {
        const r = await fetch('/sohbet-getir');
        const m = await r.json();
        const box = document.getElementById('chat-box');
        const isAtBottom = box.scrollHeight - box.scrollTop <= box.clientHeight + 50;
        box.innerHTML = m.map(msg => `<div><strong>${msg.user}:</strong> ${msg.text}</div>`).join('');
        if(isAtBottom) box.scrollTop = box.scrollHeight;
    }

    // --- 캻뢻EM KAYIT ---
    async function islemKaydet() {
        const tip = document.getElementById('p-tip').value;
        const h = document.getElementById('p-hisse').value;
        const a = document.getElementById('p-adet').value;
        const f = document.getElementById('p-fiyat').value;

        if(!h || !a || !f) return alert("Hisse se칞in ve t칲m alanlar캼 doldurun!");

        const btn = document.getElementById('islem-btn');
        btn.disabled = true; btn.innerText = "Kaydediliyor...";

        const r = await fetch('/islem-kaydet', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ kullanici: myName, hisse: h, adet: a, fiyat: f, tip: tip })
        });

        if(r.ok) {
            alert("캻륿em Ba르r캼yla Kaydedildi!");
            document.getElementById('p-adet').value = "";
            document.getElementById('p-fiyat').value = "";
            verileriYenile();
        } else {
            const err = await r.json();
            alert("Hata: " + err.mesaj);
        }
        btn.disabled = false; btn.innerText = "캻뢻EM캻 ONAYLA";
    }

    // --- Y칐NET캻C캻 FONKS캻YONLARI ---
    async function mesajGonder() {
        const i = document.getElementById('chat-inp'); if(!i.value) return;
        await fetch('/mesaj-gonder', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user:myName, text:i.value})});
        i.value = ""; chatYenile();
    }
    function openModal() {
        document.getElementById('user-modal-list').innerHTML = userListData.map(u => `<div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span>${u}</span><button class="btn-danger" style="width:auto; padding:3px 10px;" onclick="kullaniciSil('${u}')">S캻L</button></div>`).join('');
        document.getElementById('user-modal').style.display='flex';
    }
    function closeModal() { document.getElementById('user-modal').style.display='none'; }
    async function kullaniciSil(u) { await fetch('/kullanici-sil', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u})}); verileriYenile(); closeModal(); }
    async function hisseEkle() {
        const h = document.getElementById('h-kod').value.toUpperCase(), hedef = document.getElementById('h-hedef').value;
        await fetch('/hisse-ekle', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({hisse:h, hedef})});
        verileriYenile();
    }
    async function hisseSil(k) { if(confirm("Silinsin mi?")) { await fetch('/hisse-sil', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({hisse:k})}); verileriYenile(); } }
    async function tabloTemizle(t) { if(confirm("Emin misiniz?")) { await fetch('/tablo-temizle', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({tablo:t})}); location.reload(); } }
    async function loglariGetir() {
        const r = await fetch('/loglari-getir');
        const l = await r.json();
        document.getElementById('log-box').innerHTML = l.map(log => `<div>${log.time} - ${log.user}</div>`).join('');
    }
    async function kullaniciEkle() {
        const u = document.getElementById('new-user').value, p = document.getElementById('new-pass').value;
        await fetch('/kullanici-ekle', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p})});
        alert("Kullan캼c캼 eklendi."); verileriYenile();
    }
</script>
</body>
</html>