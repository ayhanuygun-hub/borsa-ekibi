<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Ekip Terminali v11.0</title>
    <style>
        :root { --bg: #0b0f19; --card: #161e2d; --accent: #38bdf8; --buy: #10b981; --sell: #f43f5e; --text: #f1f5f9; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .container { display: flex; width: 100%; height: 100%; }
        .col { display: flex; flex-direction: column; height: 100%; box-sizing: border-box; padding: 10px; border-right: 1px solid #232d3f; }
        .col-sinyaller { width: 22%; min-width: 250px; background: #0f172a; overflow-y: auto; }
        .col-islem { width: 25%; min-width: 300px; background: #0f172a; overflow-y: auto; }
        .col-grafik { width: 53%; background: #000; padding: 0; position: relative; }
        
        #setup-layer { position: fixed; inset: 0; background: var(--bg); z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .setup-card { background: var(--card); padding: 30px; border-radius: 12px; border: 1px solid var(--accent); width: 300px; text-align: center; }
        .card { background: var(--card); padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid var(--accent); cursor: pointer; transition: 0.2s; }
        .card:hover { border-left-width: 10px; background: #1e293b; }
        
        input, select { width: 100%; padding: 8px; margin: 4px 0; border-radius: 6px; border: 1px solid #334155; background: #0b0f19; color: white; font-size: 0.8rem; box-sizing: border-box; }
        button { cursor: pointer; padding: 10px; border: none; border-radius: 6px; font-weight: bold; width: 100%; margin-top: 5px; }
        .btn-success { background: var(--buy); color: white; }
        .btn-danger { background: var(--sell); color: white; }
        
        #chat-box { flex-grow: 1; min-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 8px; font-size: 0.75rem; border: 1px solid #232d3f; margin-bottom: 5px; }
        .islem-satir { font-size: 0.7rem; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 5px; margin-bottom: 3px; border-radius: 4px; }
        
        .modal { display: none; position: fixed; z-index: 6000; inset: 0; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
        .modal-content { background: var(--card); padding: 20px; border-radius: 12px; width: 350px; border: 1px solid var(--accent); }
    </style>
</head>
<body>

<div id="setup-layer">
    <div class="setup-card">
        <h3>ğŸ“Š Ekip GiriÅŸi</h3>
        <input type="text" id="setup-name" placeholder="AdÄ±nÄ±z">
        <input type="password" id="setup-pass" placeholder="Åifre">
        <select id="setup-role"><option value="kullanici">KullanÄ±cÄ±</option><option value="yonetici">YÃ¶netici</option></select>
        <button style="background:var(--accent); color:#000;" onclick="sistemiKur()">GÄ°RÄ°Å YAP</button>
    </div>
</div>

<div id="user-modal" class="modal">
    <div class="modal-content">
        <h4>ğŸ‘¥ KullanÄ±cÄ± YÃ¶netimi</h4>
        <div style="background:#0f172a; padding:10px; border-radius:8px; border:1px solid #334155; margin-bottom:10px;">
            <strong>Yeni Ekle</strong>
            <input type="text" id="new-user" placeholder="KullanÄ±cÄ± AdÄ±">
            <input type="text" id="new-pass" placeholder="Åifre">
            <button class="btn-success" style="padding:5px;" onclick="kullaniciEkle()">Kaydet</button>
        </div>
        <div id="user-modal-list" style="max-height:150px; overflow-y:auto;"></div>
        <button style="background:var(--accent); color:#000;" onclick="closeModal()">Kapat</button>
    </div>
</div>

<div class="container">
    <div class="col col-sinyaller">
        <h4>ğŸ“‰ Sinyaller</h4>
        <div id="stock-list"></div>
        <div id="admin-panel" style="display:none; border-top:1px solid var(--accent); margin-top:10px; padding-top:10px;">
            <input type="text" id="h-kod" placeholder="Hisse">
            <input type="number" id="h-hedef" placeholder="Hedef">
            <button class="btn-success" onclick="hisseEkle()">YAYINLA</button>
            <button style="background:var(--accent); color:#000;" onclick="openModal()">KULLANICILAR</button>
            <button style="background:orange; color:black;" onclick="window.location.href='/excel-indir'">ğŸ“Š EXCEL RAPORU</button>
        </div>
        <button style="background:none; color:#555; font-size:9px; margin-top:20px;" onclick="cikisyap()">ğŸšª Ã‡IKIÅ YAP</button>
    </div>

    <div class="col col-islem">
        <div class="card" style="border-left-color: gold; cursor:default;">
            <h4 style="margin:0 0 5px 0;">ğŸ“Š Ä°ÅŸlem GiriÅŸi</h4>
            <select id="p-tip"><option value="ALIS">ğŸŸ¢ ALIM YAPTIM</option><option value="SATIS">ğŸ”´ SATIÅ YAPTIM</option></select>
            <input type="text" id="p-hisse" placeholder="Soldan Hisse SeÃ§in" readonly>
            <input type="number" id="p-adet" placeholder="Adet">
            <input type="number" id="p-fiyat" placeholder="Fiyat">
            <button id="islem-btn" class="btn-success" onclick="islemKaydet()">Ä°ÅLEMÄ° ONAYLA</button>
        </div>

        <div style="background:rgba(255,215,0,0.1); padding:8px; border-radius:8px; margin-bottom:10px;">
            <small style="color:gold;">GerÃ§ekleÅŸen Toplam KÃ¢r:</small> <br><strong id="total-realized" style="font-size:1.1rem;">0.00 TL</strong>
        </div>

        <div style="margin-bottom:10px;">
            <h5 style="margin:0 0 5px 0;">ğŸ•’ Son Ä°ÅŸlemlerim <small>(Hata Sil)</small></h5>
            <div id="islem-gecmisi"></div>
        </div>

        <h4>ğŸ’¬ Sohbet</h4>
        <div id="chat-box"></div>
        <div style="display:flex; gap:5px;">
            <input type="text" id="chat-inp" placeholder="Mesaj... (Enter)" onkeyup="if(event.key==='Enter') mesajGonder()">
            <button style="background:var(--accent); color:#000; width:auto; padding:0 10px;" onclick="mesajGonder()">ğŸš€</button>
        </div>
    </div>

    <div class="col col-grafik">
        <div style="position:absolute; top:8px; left:8px; z-index:100; display:flex; gap:5px;">
            <button class="btn-primary" style="width:auto; padding:4px 10px; font-size:10px; background:rgba(22,30,45,0.9); border:1px solid var(--accent); color:#fff;" onclick="window.open('https://trade.a1capital.com.tr/')">ğŸš€ A1 TRADE</button>
            <button class="btn-primary" style="width:auto; padding:4px 10px; font-size:10px; background:rgba(22,30,45,0.9); border:1px solid gold; color:gold;" id="invest-btn" onclick="openInvesting()">ğŸ”— INVESTING</button>
        </div>
        <div id="chart-div" style="width:100%; height:100%;"></div>
    </div>
</div>

<script>
    let myName = localStorage.getItem("name");
    let myRole = localStorage.getItem("role");
    let currentSymbol = "THYAO";

    async function sistemiKur() {
        const user = document.getElementById('setup-name').value, pass = document.getElementById('setup-pass').value, role = document.getElementById('setup-role').value;
        const r = await fetch('/giris-yap', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user, sifre:pass, rol:role})});
        if(r.ok) { localStorage.setItem("name", user); localStorage.setItem("role", role); location.reload(); } else alert("GiriÅŸ HatalÄ±!");
    }

    function cikisyap() { localStorage.clear(); location.reload(); }
    if(myName && myRole) { document.getElementById('setup-layer').style.display='none'; baslat(); }

    function baslat() {
        if(myRole === 'yonetici') document.getElementById('admin-panel').style.display = 'block';
        updateChart("THYAO");
        verileriYenile(); setInterval(verileriYenile, 20000);
        chatYenile(); setInterval(chatYenile, 3000);
    }

    function updateChart(s) {
        currentSymbol = s.replace(".IS", "");
        document.getElementById('chart-div').innerHTML = `<iframe src="https://tr.investing.com/common/technical_chart.php?symbol=${currentSymbol}&type=line&width=100%&height=100%" style="width:100%; height:100%;" frameborder="0"></iframe>`;
        document.getElementById('invest-btn').innerText = `ğŸ”— ${currentSymbol}`;
    }
    function openInvesting() { window.open(`https://tr.investing.com/equities/${currentSymbol.toLowerCase()}`, '_blank'); }

    async function verileriYenile() {
        try {
            const r = await fetch(`/borsa-verileri?user=${myName}`);
            const d = await r.json();
            
            // Hisse Listesi
            const list = document.getElementById('stock-list');
            list.innerHTML = "";
            d.hisseler.forEach(h => {
                const up = d.user_portfoy[h.sembol] || {adet:0, maliyet:0};
                let portHTML = up.adet > 0 ? `<div style="font-size:0.7rem; color:gold;">Elinizde: ${up.adet} ad. | Maliyet: ${up.maliyet.toFixed(2)}</div>` : "";
                list.innerHTML += `<div class="card ${h.durum==='AL'?'active-buy':''}" onclick="updateChart('${h.sembol}'); document.getElementById('p-hisse').value='${h.sembol}';">
                    <div style="display:flex; justify-content:space-between;"><strong>${h.sembol}</strong><span>${h.fiyat>0?h.fiyat.toFixed(2):'...'}</span></div>
                    ${portHTML}
                </div>`;
            });

            // Ä°ÅŸlem GeÃ§miÅŸi (Silme Butonlu)
            document.getElementById('islem-gecmisi').innerHTML = d.islem_gecmisi.map(i => `
                <div class="islem-satir">
                    <span>${i.tip=='ALIS'?'ğŸŸ¢':'ğŸ”´'} ${i.hisse} - ${i.adet} ad.</span>
                    <button onclick="islemSil('${i._id}')" style="width:auto; padding:2px 5px; margin:0; background:none; color:var(--sell);">ğŸ—‘ï¸</button>
                </div>
            `).join('');

            document.getElementById('total-realized').innerText = d.user_kar.toFixed(2) + " TL";
            
            // Modal iÃ§in kullanÄ±cÄ± listesi
            window.userListData = d.kullanicilar;
        } catch(e) {}
    }

    async function islemKaydet() {
        const tip = document.getElementById('p-tip').value, h = document.getElementById('p-hisse').value, a = document.getElementById('p-adet').value, f = document.getElementById('p-fiyat').value;
        if(!h || !a || !f) return alert("Eksik bilgi!");
        await fetch('/islem-kaydet', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user:myName, hisse:h, adet:parseInt(a), fiyat:parseFloat(f), tip:tip})});
        document.getElementById('p-adet').value=""; document.getElementById('p-fiyat').value=""; verileriYenile();
    }

    async function islemSil(id) {
        if(!confirm("Bu iÅŸlemi silmek istediÄŸine emin misin? Kar/Zarar ve maliyetin yeniden hesaplanacak.")) return;
        await fetch('/islem-sil', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:id})});
        verileriYenile();
    }

    async function chatYenile() {
        const r = await fetch('/sohbet-getir');
        const m = await r.json();
        document.getElementById('chat-box').innerHTML = m.map(msg => `<div><strong>${msg.user}:</strong> ${msg.text}</div>`).join('');
    }

    async function mesajGonder() {
        const i = document.getElementById('chat-inp'); if(!i.value) return;
        await fetch('/mesaj-gonder', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user:myName, text:i.value})});
        i.value = ""; chatYenile();
    }

    // YÃ–NETÄ°CÄ° MODAL Ä°ÅLEMLERÄ°
    function openModal() {
        document.getElementById('user-modal-list').innerHTML = window.userListData.map(u => `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${u}</span><button class="btn-danger" style="width:auto; padding:2px 8px;" onclick="kullaniciSil('${u}')">SÄ°L</button></div>`).join('');
        document.getElementById('user-modal').style.display='flex';
    }
    function closeModal() { document.getElementById('user-modal').style.display='none'; }
    async function kullaniciSil(u) { if(confirm("KullanÄ±cÄ± silinsin mi?")) { await fetch('/kullanici-sil', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u})}); verileriYenile(); closeModal(); } }
    async function kullaniciEkle() {
        const u = document.getElementById('new-user').value, p = document.getElementById('new-pass').value;
        await fetch('/kullanici-ekle', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p})});
        verileriYenile(); closeModal();
    }
    async function hisseEkle() {
        await fetch('/hisse-ekle', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({hisse:document.getElementById('h-kod').value.toUpperCase(), hedef:document.getElementById('h-hedef').value})});
        verileriYenile();
    }
    async function tabloTemizle(t) { if(confirm("Emin misiniz?")) { await fetch('/tablo-temizle', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({tablo:t})}); location.reload(); } }
</script>
</body>
</html>