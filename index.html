<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Borsa Ekip Terminali v6.0</title>
    <script src="https://meet.jit.si/external_api.js"></script>
    <style>
        :root { --bg: #0b0f19; --card: #161e2d; --accent: #38bdf8; --buy: #10b981; --sell: #f43f5e; --text: #f1f5f9; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* 3 SÃœTUNLU YAPI */
        .col-left { width: 25%; border-right: 1px solid #2d3748; padding: 15px; overflow-y: auto; background: #0f172a; }
        .col-main { width: 50%; display: flex; flex-direction: column; background: #000; position: relative; }
        .col-right { width: 25%; border-left: 1px solid #2d3748; padding: 15px; display: flex; flex-direction: column; background: #0f172a; }

        #setup-layer { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .setup-card { background: var(--card); padding: 30px; border-radius: 12px; border: 1px solid var(--accent); width: 320px; text-align: center; }

        .card { background: var(--card); padding: 12px; border-radius: 10px; margin-bottom: 12px; border-left: 4px solid var(--accent); }
        .active-buy { border-left-color: var(--buy); background: #064e3b !important; }
        input { width: 100%; padding: 8px; margin: 5px 0; border-radius: 6px; border: 1px solid #2d3748; background: #0b0f19; color: white; box-sizing: border-box; font-size: 0.85rem; }
        button { cursor: pointer; padding: 10px; border: none; border-radius: 6px; font-weight: bold; width: 100%; margin-top: 5px; }
        .btn-primary { background: var(--accent); color: #000; }
        .btn-success { background: var(--buy); color: white; }
        
        /* CHAT STÄ°LLERÄ° */
        #chat-content { flex-grow: 1; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 10px; font-size: 0.85rem; }
        .msg { margin-bottom: 10px; border-bottom: 1px solid #1e293b; padding-bottom: 5px; }
        
        .portfolio-mini { font-size: 0.75rem; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 5px; margin-top: 5px; }
        .kz-pos { color: var(--buy); } .kz-neg { color: var(--sell); }
    </style>
</head>
<body>

<div id="setup-layer">
    <div class="setup-card">
        <h3>ðŸ“Š Ekip GiriÅŸi</h3>
        <input type="text" id="setup-name" placeholder="AdÄ±nÄ±z SoyadÄ±nÄ±z">
        <select id="setup-role" style="width:100%; padding:8px; background:#0b0f19; color:white; border-radius:6px; margin:5px 0;">
            <option value="kullanici">KullanÄ±cÄ±</option>
            <option value="yonetici">YÃ¶netici</option>
        </select>
        <input type="password" id="setup-pass" placeholder="Åžifre">
        <button class="btn-primary" onclick="sistemiKur()">BAÅžLAT</button>
    </div>
</div>

<div class="col-left">
    <h4 style="border-bottom: 1px solid var(--accent); padding-bottom: 5px;">ðŸ“‰ Sinyaller</h4>
    <div id="stock-list"></div>
    
    <div id="admin-panel" style="display:none; margin-top:20px; border-top: 2px solid var(--accent); padding-top:15px;">
        <strong>ðŸ“¢ Sinyal GÃ¶nder</strong>
        <input type="text" id="h-kod" placeholder="Hisse (THYAO)">
        <input type="number" id="h-hedef" placeholder="Hedef Fiyat">
        <button class="btn-success" onclick="hisseEkle()">YAYINLA</button>
        <button class="btn-primary" onclick="window.location.href='/excel-indir'">ðŸ“Š EXCEL RAPORU</button>
    </div>
</div>

<div class="col-main">
    <div id="video-container" style="width: 100%; height: 100%;"></div>
    <div id="meet-btn" style="position: absolute; top:50%; left:50%; transform:translate(-50%,-50%);">
        <button class="btn-primary" style="padding: 15px 30px;" onclick="startMeeting()">GÃ–RÃœÅžMEYE KATIL</button>
    </div>
</div>

<div class="col-right">
    <h4 style="border-bottom: 1px solid #f59e0b; padding-bottom: 5px;">ðŸ’¬ Ekip Sohbeti</h4>
    <div id="chat-content"></div>
    <div style="display:flex; gap:5px;">
        <input type="text" id="chat-input" placeholder="Mesaj..." style="margin:0;">
        <button class="btn-primary" style="width:auto; margin:0;" onclick="mesajGonder()">ðŸš€</button>
    </div>

    <div id="admin-summary" style="display:none; margin-top:20px;">
        <h4 style="border-bottom: 1px solid var(--buy); padding-bottom: 5px;">ðŸ‘¥ Ekip Ã–zeti</h4>
        <div id="summary-content" style="font-size: 0.8rem;"></div>
    </div>
</div>

<script>
    let myName = localStorage.getItem("name");
    let myRole = localStorage.getItem("role");

    async function sistemiKur() {
        const name = document.getElementById('setup-name').value.trim();
        const role = document.getElementById('setup-role').value;
        const pass = document.getElementById('setup-pass').value.trim();
        if(!name || !pass) return alert("Eksik bilgi!");

        const resp = await fetch('/giris-yap', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({rol: role, sifre: pass})
        });

        if(resp.ok) {
            localStorage.setItem("name", name);
            localStorage.setItem("role", role);
            location.reload();
        } else alert("Åžifre yanlÄ±ÅŸ!");
    }

    if(myName && myRole) {
        document.getElementById('setup-layer').style.display = 'none';
        baslat();
    }

    function baslat() {
        if(myRole === 'yonetici') {
            document.getElementById('admin-panel').style.display = 'block';
            document.getElementById('admin-summary').style.display = 'block';
        }
        verileriYenile();
        setInterval(verileriYenile, 30000);
    }

    async function verileriYenile() {
        try {
            const resp = await fetch('/borsa-verileri');
            const data = await resp.json();
            
            // Hisse Listesi
            const list = document.getElementById('stock-list');
            list.innerHTML = "";
            data.hisseler.forEach(h => {
                const isAL = h.durum === "AL";
                const userPort = data.ekip[myName] ? data.ekip[myName][h.sembol] : null;
                let portHTML = "";
                if(userPort && userPort.adet > 0) {
                    const kz = (h.fiyat - userPort.maliyet) * userPort.adet;
                    portHTML = `<div class="portfolio-mini">PortfÃ¶y: ${userPort.adet} ad. <br> K/Z: <span class="${kz>=0?'kz-pos':'kz-neg'}">${kz.toFixed(1)} TL</span></div>`;
                }

                list.innerHTML += `
                    <div class="card ${isAL ? 'active-buy' : ''}">
                        <div style="display:flex; justify-content:space-between; font-weight:bold;">
                            <span>${h.sembol}</span>
                            <span style="font-size:1.1rem;">${h.fiyat > 0 ? h.fiyat.toFixed(2) : '...'}</span>
                        </div>
                        <small>Hedef: ${h.hedef}</small>
                        ${portHTML}
                        ${myRole === 'kullanici' ? `<div style="display:flex; gap:3px; margin-top:5px;">
                            <input type="number" id="q-${h.sembol}" placeholder="Adet" value="${userPort?userPort.adet:''}">
                            <input type="number" id="c-${h.sembol}" placeholder="Mly" value="${userPort?userPort.maliyet:''}">
                            <button class="btn-success" style="width:30px; padding:0;" onclick="portGuncelle('${h.sembol}')">ðŸ’¾</button>
                        </div>` : `<button onclick="hisseSil('${h.sembol}')" style="background:none; color:var(--sell); font-size:10px; padding:0;">Sinyali KaldÄ±r</button>`}
                    </div>`;
            });

            // Chat
            const chat = document.getElementById('chat-content');
            chat.innerHTML = data.mesajlar.map(m => `<div class="msg"><strong>${m.user}:</strong> ${m.text} <br><small style="opacity:0.4;">${m.time}</small></div>`).join('');
            chat.scrollTop = chat.scrollHeight;

            // Admin Ã–zet
            if(myRole === 'yonetici') {
                const summ = document.getElementById('summary-content');
                summ.innerHTML = Object.entries(data.ekip).map(([u, a]) => `<div><strong>${u}:</strong> ${Object.keys(a).length} Hisse</div>`).join('');
            }
        } catch(e) {}
    }

    async function portGuncelle(h) {
        const adet = document.getElementById(`q-${h}`).value;
        const maliyet = document.getElementById(`c-${h}`).value;
        await fetch('/adet-guncelle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({kullanici: myName, hisse: h, adet, maliyet})
        });
        verileriYenile();
    }

    async function mesajGonder() {
        const inp = document.getElementById('chat-input');
        if(!inp.value) return;
        await fetch('/mesaj-gonder', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({user: myName, text: inp.value})
        });
        inp.value = "";
        verileriYenile();
    }

    async function hisseEkle() {
        const h = document.getElementById('h-kod').value.toUpperCase();
        const hedef = document.getElementById('h-hedef').value;
        await fetch('/hisse-ekle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({hisse: h, hedef})
        });
        verileriYenile();
    }

    async function hisseSil(h) {
        await fetch('/hisse-sil', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({hisse: h})
        });
        verileriYenile();
    }

    function startMeeting() {
        document.getElementById('meet-btn').style.display = 'none';
        new JitsiMeetExternalAPI("meet.jit.si", { roomName: "BorsaEkibi_V6_Final", parentNode: document.querySelector('#video-container') });
    }
</script>
</body>
</html>