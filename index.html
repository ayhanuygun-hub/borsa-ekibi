<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Ekip Terminal v8.6</title>
    <script src="https://meet.jit.si/external_api.js"></script>
    <style>
        :root { --bg: #0b0f19; --card: #161e2d; --accent: #38bdf8; --buy: #10b981; --sell: #f43f5e; --text: #f1f5f9; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .col { padding: 15px; display: flex; flex-direction: column; height: 100%; box-sizing: border-box; }
        .col-left { width: 25%; border-right: 1px solid #2d3748; background: #0f172a; overflow-y: auto; }
        .col-main { width: 50%; background: #000; position: relative; }
        .col-right { width: 25%; border-left: 1px solid #2d3748; background: #0f172a; overflow-y: auto; }
        
        #setup-layer { position: fixed; inset: 0; background: var(--bg); z-index: 1500; display: flex; align-items: center; justify-content: center; }
        .setup-card { background: var(--card); padding: 30px; border-radius: 12px; border: 1px solid var(--accent); width: 320px; text-align: center; }
        .card { background: var(--card); padding: 12px; border-radius: 10px; margin-bottom: 12px; border-left: 4px solid var(--accent); }
        .active-buy { border-left-color: var(--buy); background: #064e3b !important; }
        
        input, select { width: 100%; padding: 8px; margin: 5px 0; border-radius: 6px; border: 1px solid #2d3748; background: #0b0f19; color: white; box-sizing: border-box; }
        button { cursor: pointer; padding: 10px; border: none; border-radius: 6px; font-weight: bold; width: 100%; margin-top: 5px; }
        .btn-primary { background: var(--accent); color: #000; }
        .btn-danger { background: var(--sell); color: white; }
        
        #chat-box, #log-box { flex-grow: 1; min-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; font-size: 0.8rem; border: 1px solid #334155; }
        .price-tag { font-size: 1.2rem; font-weight: 800; color: #fff; }
        .kz-pos { color: var(--buy); } .kz-neg { color: var(--sell); }

        /* MODAL STÄ°LLERÄ° */
        .modal { display: none; position: fixed; z-index: 2000; inset: 0; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { background: var(--card); padding: 25px; border-radius: 15px; width: 400px; border: 1px solid var(--accent); max-height: 80vh; overflow-y: auto; }
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #2d3748; }
    </style>
</head>
<body>

<div id="setup-layer">
    <div class="setup-card">
        <h3>ğŸ“Š Ekip Terminali</h3>
        <input type="text" id="setup-name" placeholder="KullanÄ±cÄ± AdÄ±">
        <input type="password" id="setup-pass" placeholder="Åifre">
        <select id="setup-role"><option value="kullanici">KullanÄ±cÄ±</option><option value="yonetici">YÃ¶netici</option></select>
        <button class="btn-primary" onclick="sistemiKur()">GÄ°RÄ°Å</button>
    </div>
</div>

<div id="user-modal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">ğŸ‘¥ KullanÄ±cÄ± YÃ¶netimi</h3>
        <div id="user-modal-list"></div>
        <button class="btn-primary" style="margin-top:20px;" onclick="closeModal()">Kapat</button>
    </div>
</div>

<div class="col col-left">
    <button style="background:transparent; color:#666; font-size:10px; border:1px solid #333;" onclick="cikisyap()">ğŸšª Ã‡IKIÅ</button>
    <h4>ğŸ“‰ Sinyaller</h4>
    <div id="stock-list"></div>
    
    <div id="admin-panel" style="display:none; border-top: 2px solid var(--accent); padding-top:15px; margin-top:15px;">
        <strong>ğŸ“¢ YÃ¶netim Paneli</strong>
        <input type="text" id="h-kod" placeholder="Hisse">
        <input type="number" id="h-hedef" placeholder="Hedef">
        <button style="background:var(--buy); color:white;" onclick="hisseEkle()">SÄ°NYALÄ° YAYINLA</button>
        
        <div style="margin-top:20px; border-top:1px solid #334155; padding-top:15px;">
            <strong>ğŸ‘¤ KullanÄ±cÄ± Ä°ÅŸlemleri</strong>
            <button class="btn-primary" style="background:#f59e0b;" onclick="openModal()">ğŸ‘¥ KULLANICILARI YÃ–NET</button>
            <input type="text" id="new-user" placeholder="Yeni Ad">
            <input type="text" id="new-pass" placeholder="Åifre">
            <button class="btn-primary" onclick="kullaniciEkle()">YENÄ° KULLANICI KAYDET</button>
        </div>
        <button class="btn-primary" style="margin-top:15px; background:white; color:black;" onclick="window.location.href='/excel-indir'">ğŸ“Š EXCEL Ã‡IKTISI</button>
    </div>
</div>

<div class="col col-main">
    <div id="video-container" style="width: 100%; height: 100%;"></div>
    <div id="meet-btn" style="position: absolute; top:50%; left:50%; transform:translate(-50%,-50%);">
        <button class="btn-primary" style="padding: 15px 30px; width: auto;" onclick="startMeeting()">ğŸ“ GÃ–RÃœÅMEYÄ° BAÅLAT</button>
    </div>
</div>

<div class="col col-right">
    <h4>ğŸ’¬ Sohbet <button onclick="tabloTemizle('chat')" style="float:right; width:auto; font-size:9px;" class="btn-danger">Temizle</button></h4>
    <div id="chat-box"></div>
    <div style="display:flex; gap:5px; margin-bottom:15px;">
        <input type="text" id="chat-inp" placeholder="Mesaj..." style="margin:0;">
        <button class="btn-primary" style="width:auto; margin:0; padding:0 15px;" onclick="mesajGonder()">ğŸš€</button>
    </div>

    <div id="admin-view" style="display:none;">
        <h4>ğŸ•’ Sistem LoglarÄ± <button onclick="tabloTemizle('logs')" style="float:right; width:auto; font-size:9px;" class="btn-danger">SÄ±fÄ±rla</button></h4>
        <div id="log-box"></div>
    </div>
</div>

<script>
    let myName = localStorage.getItem("name");
    let myRole = localStorage.getItem("role");
    let userListData = []; // KullanÄ±cÄ±larÄ± modal iÃ§in saklayalÄ±m

    async function sistemiKur() {
        const user = document.getElementById('setup-name').value;
        const pass = document.getElementById('setup-pass').value;
        const role = document.getElementById('setup-role').value;
        const r = await fetch('/giris-yap', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user, sifre:pass, rol:role})});
        if(r.ok) { localStorage.setItem("name", user); localStorage.setItem("role", role); location.reload(); } else alert("HatalÄ± GiriÅŸ!");
    }

    function cikisyap() { localStorage.clear(); location.reload(); }

    if(myName && myRole) { document.getElementById('setup-layer').style.display='none'; baslat(); }

    function baslat() {
        if(myRole === 'yonetici') {
            document.getElementById('admin-panel').style.display = 'block';
            document.getElementById('admin-view').style.display = 'block';
            setInterval(loglariGetir, 10000); loglariGetir();
        }
        
        verileriYenile(); 
        setInterval(verileriYenile, 30000); // Fiyatlar 30 saniyede bir

        chatYenile();
        setInterval(chatYenile, 3000); // Sohbet her 3 saniyede bir (ANLIK)
    }

    async function verileriYenile() {
        try {
            const r = await fetch('/borsa-verileri');
            const d = await r.json();
            userListData = d.kullanicilar; // Modal iÃ§in gÃ¼ncel tut

            const list = document.getElementById('stock-list');
            list.innerHTML = "";
            d.hisseler.forEach(h => {
                const up = d.portfoyler[myName] ? d.portfoyler[myName][h.sembol] : null;
                let portHTML = "";
                if(up && up.adet > 0) {
                    const kz = (h.fiyat - up.maliyet) * up.adet;
                    portHTML = `<div style="font-size:0.75rem; margin-top:5px; background:rgba(0,0,0,0.5); padding:5px; border-radius:5px;">${up.adet} ad. | K/Z: <span class="${kz>=0?'kz-pos':'kz-neg'}">${kz.toFixed(1)} TL</span></div>`;
                }
                list.innerHTML += `
                    <div class="card ${h.durum === 'AL' ? 'active-buy' : ''}">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <strong>${h.sembol}</strong>
                            <span class="price-tag">${h.fiyat > 0 ? h.fiyat.toFixed(2) : '...'}</span>
                        </div>
                        ${portHTML}
                        ${myRole === 'kullanici' ? `<div style="display:flex; gap:3px; margin-top:8px;"><input type="number" id="q-${h.sembol}" placeholder="Adet" value="${up?up.adet:''}"><input type="number" id="c-${h.sembol}" placeholder="Mly" value="${up?up.maliyet:''}"><button style="background:var(--buy); width:40px;" onclick="portGuncelle('${h.sembol}')">ğŸ’¾</button></div>` : `<button class="btn-danger" style="width:100%;" onclick="hisseSil('${h.sembol}')">ğŸ—‘ï¸ SÄ°NYALÄ° SÄ°L</button>`}
                    </div>`;
            });
        } catch(e) {}
    }

    async function chatYenile() {
        try {
            const r = await fetch('/sohbet-getir');
            const m = await r.json();
            const box = document.getElementById('chat-box');
            const isAtBottom = box.scrollHeight - box.scrollTop <= box.clientHeight + 50;
            box.innerHTML = m.map(msg => `<div><small style="opacity:0.4">${msg.time}</small> <strong>${msg.user}:</strong> ${msg.text}</div>`).join('');
            if(isAtBottom) box.scrollTop = box.scrollHeight;
        } catch(e) {}
    }

    async function mesajGonder() {
        const i = document.getElementById('chat-inp');
        if(!i.value) return;
        await fetch('/mesaj-gonder', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user:myName, text:i.value})});
        i.value = "";
        chatYenile(); // GÃ¶nderdikten sonra beklemeden yenile
    }

    // MODAL FONKSÄ°YONLARI
    function openModal() {
        const mList = document.getElementById('user-modal-list');
        mList.innerHTML = userListData.map(u => `
            <div class="user-item">
                <span>${u}</span>
                <button class="btn-danger" style="width:auto; padding:3px 10px;" onclick="kullaniciSil('${u}')">SÄ°L</button>
            </div>
        `).join('') || "HenÃ¼z kullanÄ±cÄ± yok.";
        document.getElementById('user-modal').style.display = 'flex';
    }
    function closeModal() { document.getElementById('user-modal').style.display = 'none'; }

    // DÄ°ÄER FONKSÄ°YONLAR
    async function loglariGetir() {
        const r = await fetch('/loglari-getir');
        const l = await r.json();
        document.getElementById('log-box').innerHTML = l.map(log => `<div><small>${log.time}</small> <strong>${log.user}</strong></div>`).join('');
    }
    async function kullaniciSil(u) {
        if(confirm(u + " silinecek?")) {
            await fetch('/kullanici-sil', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u})});
            verileriYenile(); // Listeyi gÃ¼ncelle
            setTimeout(openModal, 500); // ModalÄ± yenile
        }
    }
    async function tabloTemizle(t) { if(confirm("Temizlensin mi?")) { await fetch('/tablo-temizle', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({tablo:t})}); location.reload(); } }
    async function hisseEkle() {
        const h = document.getElementById('h-kod').value.toUpperCase();
        const hedef = document.getElementById('h-hedef').value;
        await fetch('/hisse-ekle', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({hisse:h, hedef})});
        verileriYenile();
    }
    async function hisseSil(k) { await fetch('/hisse-sil', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({hisse:k})}); verileriYenile(); }
    async function portGuncelle(h) {
        const a = document.getElementById(`q-${h}`).value, m = document.getElementById(`c-${h}`).value;
        await fetch('/adet-guncelle', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({kullanici:myName, hisse:h, adet:a, maliyet:m})});
        alert("PortfÃ¶y Kaydedildi."); verileriYenile();
    }
    async function kullaniciEkle() {
        const u = document.getElementById('new-user').value, p = document.getElementById('new-pass').value;
        await fetch('/kullanici-ekle', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p})});
        alert("Yeni KullanÄ±cÄ± Eklendi."); verileriYenile();
    }
    function startMeeting() { document.getElementById('meet-btn').style.display='none'; new JitsiMeetExternalAPI("meet.jit.si", { roomName: "BorsaGrup_v86", parentNode: document.querySelector('#video-container') }); }
</script>
</body>
</html>